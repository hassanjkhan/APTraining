<!DOCTYPE html>
<html>
<head>
<!-- Load TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
<!-- Load BodyPix -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>

<meta charset="utf-8">
<title>Display Webcam Stream</title>

<style>
#container {
	margin: 0px auto;
	width: 500px;
	height: 375px;
	border: 10px #333 solid;
}
#videoElement {
	width: 500px;
	height: 375px;
	background-color: #666;
  transform: rotateY(180deg); 
}
</style>
</head>

<body>
<h2 id = "frames">Frame: </h2>
<div id="container">
  <video autoplay="true" id="videoElement"></video>
  <p id="feedback"> </p>
  <canvas id="canvas" width="640" height ="480"></canvas>
  
</div>
<script>
  var video = document.querySelector("#videoElement");
  var canvas = document.getElementById('canvas');
  canvas.style.display = "none";
  var context = canvas.getContext('2d');
  var i = 0;
if (navigator.mediaDevices.getUserMedia) {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(function (stream) {
      video.srcObject = stream;
    })
    .catch(function (err0r) {
      console.log("Something went wrong!");
    });
}

var interval = setInterval(function(){
  context.drawImage(video,0,0,640,480);
  i++;
  const img = new Image();
  img.src = canvas.toDataURL();
  async function loadAndPredict() {
      const net = await bodyPix.load({
        architecture: 'MobileNetV1',
        outputStride: 16,
        multiplier: 0.75,
        quantBytes: 2
            });
                    
      /**
       * One of (see documentation below):
       *   - net.segmentPerson
       *   - net.segmentPersonParts
       *   - net.segmentMultiPerson
       *   - net.segmentMultiPersonParts
       * See documentation below for details on each method.
       */
      const segmentation = await net.segmentPerson(img);
      //console.log(segmentation);
      overHead(segmentation);
      

    }
   loadAndPredict();
    
  },500);

  setInterval(function(){
    var header = document.getElementById("frames");
    header.innerHTML = "Frames: " + i;
    i = 0;
  }, 1000);

  //setTimeout(function(){clearInterval(interval)},20000);

  function overHead(segmentation){
    if(segmentation.allPoses.length > 0){
        var current = segmentation.allPoses[0];
        if(current.keypoints[9].score >= 0.50 && current.keypoints[10].score >= 0.50){
            if(Math.abs(current.keypoints[9].position.y - current.keypoints[10].position.y) > 40){
                if(current.keypoints[9].position.y > current.keypoints[10].position.y){
                    document.getElementById("feedback").innerHTML = "Right Wrist too high!";
                } else {
                    document.getElementById("feedback").innerHTML = "Left Wrist too high!";
                }
            } else {
                document.getElementById("feedback").innerHTML = " Wrist Balanced";
                console.log("Wrist are balanced");
            }
        } else {
            document.getElementById("feedback").innerHTML = "________________";
            console.log("current score isn't enough");
        }
        console.log(segmentation.allPoses);
    }
    
  }
</script>
</body>
</html>
